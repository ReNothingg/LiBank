<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0a84ff" />
    <title>Bank Prototype</title>
    <style>
        :root {
            --bg: #0b0c0f;
            --card: #12141a;
            --card-2: #171a21;
            --text: #f5f7fb;
            --muted: #a6aab4;
            --accent: #0a84ff;
            /* iOS blue */
            --accent-2: #30d158;
            /* iOS green */
            --danger: #ff375f;
            --success: #34c759;
            --divider: rgba(255, 255, 255, 0.08);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            --radius: 18px;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f3f4f7;
                --card: #ffffff;
                --card-2: #ffffff;
                --text: #0b0c0f;
                --muted: #5d6470;
                --divider: rgba(0, 0, 0, 0.08);
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Segoe UI", Roboto, system-ui, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .hidden {
            display: none !important;
        }

        .app {
            min-height: 100vh;
            padding-bottom: calc(88px + env(safe-area-inset-bottom));
        }

        /* Header / Balance card */
        .balance {
            position: sticky;
            top: 0;
            z-index: 2;
            padding-top: calc(14px + env(safe-area-inset-top));
            padding-bottom: 18px;
            background: linear-gradient(135deg, #0a84ff 0%, #30d158 100%);
            color: white;
            border-bottom-left-radius: 22px;
            border-bottom-right-radius: 22px;
            box-shadow: var(--shadow);
        }

        .navRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .userBadge {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: saturate(180%) blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .userName {
            font-weight: 600;
            margin-left: 10px;
            opacity: 0.95;
        }

        .topRight {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .chip {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 8px 12px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
        }

        .balanceValue {
            font-size: 44px;
            line-height: 1.15;
            font-weight: 800;
            letter-spacing: -0.5px;
            text-align: center;
            margin: 22px 16px 6px;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.25);
        }

        .balanceSub {
            text-align: center;
            opacity: 0.92;
            font-weight: 600;
        }

        /* Transactions */
        .section {
            margin: 16px;
            margin-top: 18px;
        }

        .sectionTitle {
            margin: 0 4px 10px;
            color: var(--muted);
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        .list {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .row {
            display: grid;
            grid-template-columns: 48px 1fr auto;
            align-items: center;
            gap: 12px;
            padding: 14px 14px;
            border-bottom: 1px solid var(--divider);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
        }

        .row:last-child {
            border-bottom: 0;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--card-2);
            display: grid;
            place-items: center;
            font-weight: 800;
            color: var(--accent);
            border: 1px solid var(--divider);
        }

        .title {
            font-weight: 700;
        }

        .sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 3px;
        }

        .amountPos {
            color: var(--success);
            font-weight: 800;
        }

        .amountNeg {
            color: #ff453a;
            font-weight: 800;
        }

        /* Bottom action bar */
        .fabBar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 3;
            padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
            background: rgba(20, 20, 25, 0.6);
            backdrop-filter: saturate(180%) blur(20px);
            border-top: 1px solid var(--divider);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 16px;
            padding: 14px 16px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            background: var(--accent);
            box-shadow: 0 8px 20px rgba(10, 132, 255, 0.35);
        }

        .btn.secondary {
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--divider);
            box-shadow: var(--shadow);
        }

        .btn.destructive {
            background: var(--danger);
        }

        .btn.small {
            padding: 10px 12px;
            border-radius: 12px;
            font-size: 14px;
        }

        /* Sheets */
        .sheetBackdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            transition: 0.2s ease;
        }

        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 4;
            transform: translateY(100%);
            transition: transform 0.28s cubic-bezier(.2, .8, .2, 1);
            background: var(--card);
            border-top-left-radius: 22px;
            border-top-right-radius: 22px;
            box-shadow: var(--shadow);
            max-height: 84vh;
            overflow: auto;
        }

        .sheetHeader {
            padding: 12px 16px;
            border-bottom: 1px solid var(--divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sheetOpen .sheet {
            transform: translateY(0%);
        }

        .sheetOpen .sheetBackdrop {
            opacity: 1;
            pointer-events: auto;
        }

        .sheetBody {
            padding: 16px;
        }

        .field {
            margin-bottom: 12px;
        }

        .label {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--divider);
            background: var(--card-2);
            color: var(--text);
            font-size: 16px;
        }

        .qrBox {
            display: grid;
            place-items: center;
            padding: 16px;
            background: var(--card-2);
            border-radius: 16px;
            border: 1px solid var(--divider);
        }

        .hstack {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .vstack {
            display: grid;
            gap: 8px;
        }

        /* Login screen */
        .login {
            display: grid;
            gap: 12px;
            padding: 18px;
            margin: 18px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .hint {
            color: var(--muted);
            font-size: 13px;
        }

        .center {
            text-align: center;
        }

        /* Toast */
        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(120px + env(safe-area-inset-bottom));
            background: rgba(28, 28, 30, 0.9);
            color: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: .25s ease;
            z-index: 10;
        }

        .toast.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Video scan */
        .videoWrap {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--divider);
            background: #000;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        .scanOverlay {
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 0 2px rgba(0, 255, 128, 0.6);
            border-radius: 16px;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="app" id="app">
        <div class="balance" id="header">
            <div class="navRow">
                <div class="hstack" style="gap:10px;">
                    <div class="userBadge" id="userBadge">?</div>
                    <div class="userName" id="userName">Гость</div>
                </div>
                <div class="topRight">
                    <button class="chip small" id="btnTopup">+ Пополнить</button>
                    <button class="chip small" id="btnLogout">Выйти</button>
                </div>
            </div>
            <div class="balanceValue" id="balanceValue">—</div>
            <div class="balanceSub">Доступно</div>
        </div>

        <div class="section" id="loginSection">
            <div class="login">
                <div class="center" style="font-weight:800; font-size:18px;">Вход по ID</div>
                <div class="field">
                    <div class="label">ID пользователя (для теста: 1001 или 1002)</div>
                    <input class="input" id="loginId" placeholder="Например, 1001" inputmode="numeric" />
                </div>
                <button class="btn" id="btnLogin">Войти</button>
                <div class="hint">Прототип. Данные не являются реальными, используется локальная база.</div>
            </div>
        </div>

        <div class="section hidden" id="mainSection">
            <div class="sectionTitle">История</div>
            <div class="list" id="txList"></div>
        </div>

        <div class="fabBar">
            <button class="btn secondary" id="btnCreate">Создать QR счет</button>
            <button class="btn" id="btnScan">Сканировать QR</button>
        </div>

        <!-- Sheet: Create invoice -->
        <div class="sheetBackdrop" id="createBackdrop"></div>
        <div class="sheet" id="createSheet">
            <div class="sheetHeader">
                <div style="font-weight:800;">Создать счет</div>
                <button class="btn small destructive" id="closeCreate">Закрыть</button>
            </div>
            <div class="sheetBody">
                <div class="field">
                    <div class="label">Сумма, ₽</div>
                    <input class="input" id="invAmount" type="number" inputmode="decimal"
                        placeholder="Например, 499.99" />
                </div>
                <div class="field">
                    <div class="label">Описание (необязательно)</div>
                    <input class="input" id="invDesc" placeholder="Комментарий для плательщика" maxlength="140" />
                </div>
                <div class="hstack">
                    <button class="btn" id="doCreate">Сгенерировать QR</button>
                    <button class="btn secondary" id="clearCreate">Очистить</button>
                </div>
                <div id="invResult" class="vstack" style="margin-top:14px; display:none;">
                    <div class="label">QR для оплаты:</div>
                    <div class="qrBox">
                        <img id="invQRImg" alt="QR" style="width:220px; height:220px;" />
                    </div>
                    <div class="label" id="invTextLabel" style="word-break: break-all;"></div>
                    <div class="hstack">
                        <button class="btn small" id="copyLink">Копировать ссылку</button>
                        <button class="btn small" id="saveQR">Скачать QR</button>
                        <button class="btn small" id="shareQR">Поделиться</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sheet: Scan -->
        <div class="sheetBackdrop" id="scanBackdrop"></div>
        <div class="sheet" id="scanSheet">
            <div class="sheetHeader">
                <div style="font-weight:800;">Сканировать QR</div>
                <button class="btn small destructive" id="closeScan">Закрыть</button>
            </div>
            <div class="sheetBody">
                <div class="videoWrap">
                    <video id="video" playsinline></video>
                    <div class="scanOverlay"></div>
                </div>
                <div class="hstack" style="margin-top:10px;">
                    <button class="btn small" id="startScan">Включить камеру</button>
                    <button class="btn small secondary" id="stopScan">Выключить</button>
                </div>
                <div class="field" style="margin-top:12px;">
                    <div class="label">Нет камеры? Вставьте код вручную:</div>
                    <input class="input" id="manualQR" placeholder="BANKPAY://invoice?i=INV-..." />
                    <div class="hstack" style="margin-top:8px;">
                        <button class="btn small" id="payManual">Оплатить по коду</button>
                        <label class="btn small secondary" for="imgInput">Сканировать с фото</label>
                        <input id="imgInput" type="file" accept="image/*" class="hidden" />
                    </div>
                </div>
                <canvas id="canvas" class="hidden"></canvas>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <!-- jsQR (CDN). Используем для распознавания, если нет BarcodeDetector -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const fmtMoney = (v) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(v ?? 0);
        const fmtDT = (iso) => new Intl.DateTimeFormat('ru-RU', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(iso));
        const $ = (id) => document.getElementById(id);
        const appEl = $('app');

        const loginSection = $('loginSection');
        const mainSection = $('mainSection');
        const userNameEl = $('userName');
        const userBadgeEl = $('userBadge');
        const balanceValueEl = $('balanceValue');

        const btnLogin = $('btnLogin');
        const loginId = $('loginId');
        const btnLogout = $('btnLogout');
        const btnTopup = $('btnTopup');

        const txList = $('txList');

        const btnCreate = $('btnCreate');
        const createSheet = $('createSheet');
        const createBackdrop = $('createBackdrop');
        const closeCreate = $('closeCreate');
        const doCreate = $('doCreate');
        const clearCreate = $('clearCreate');
        const invAmount = $('invAmount');
        const invDesc = $('invDesc');
        const invResult = $('invResult');
        const invQRImg = $('invQRImg');
        const invTextLabel = $('invTextLabel');
        const copyLink = $('copyLink');
        const saveQR = $('saveQR');
        const shareQR = $('shareQR');

        const btnScan = $('btnScan');
        const scanSheet = $('scanSheet');
        const scanBackdrop = $('scanBackdrop');
        const closeScan = $('closeScan');
        const startScan = $('startScan');
        const stopScan = $('stopScan');
        const video = $('video');
        const canvas = $('canvas');
        const manualQR = $('manualQR');
        const payManual = $('payManual');
        const imgInput = $('imgInput');

        const toast = $('toast');

        let currentUser = null;
        let scanStream = null;
        let scanRAF = null;
        let scanning = false;
        let usingBarcodeDetector = 'BarcodeDetector' in window;

        function showToast(msg, ms = 2000) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), ms);
        }

        function setSheetOpen(sheet, backdrop, open) {
            if (open) {
                sheet.classList.add('sheetOpen');
                backdrop.classList.add('sheetOpen');
                document.body.classList.add('sheetOpen');
            } else {
                sheet.classList.remove('sheetOpen');
                backdrop.classList.remove('sheetOpen');
                document.body.classList.remove('sheetOpen');
            }
        }

        async function api(path, opts = {}) {
            const res = await fetch(path, {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                ...opts
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.ok === false) {
                const msg = data?.error || `Ошибка ${res.status}`;
                throw new Error(msg);
            }
            return data;
        }

        function initials(name) {
            if (!name) return '?';
            const parts = name.split(' ').filter(Boolean);
            return parts.slice(0, 2).map(p => p[0].toUpperCase()).join('');
        }

        async function refreshMe() {
            try {
                const { user } = await api('/api/me');
                currentUser = user;
                userNameEl.textContent = user.name;
                userBadgeEl.textContent = initials(user.name);
                balanceValueEl.textContent = fmtMoney(user.balance);
                loginSection.classList.add('hidden');
                mainSection.classList.remove('hidden');
                await refreshTx();
            } catch (e) {
                // не залогинен
                currentUser = null;
                loginSection.classList.remove('hidden');
                mainSection.classList.add('hidden');
            }
        }

        function renderTx(txs = []) {
            txList.innerHTML = '';
            if (!txs.length) {
                txList.innerHTML = `<div class="row"><div></div><div class="sub">Нет операций</div><div></div></div>`;
                return;
            }
            for (const tx of txs) {
                const signClass = tx.signed_amount >= 0 ? 'amountPos' : 'amountNeg';
                const sign = tx.signed_amount >= 0 ? '+' : '−';
                const who = tx.counterparty ? ` · ${tx.counterparty}` : '';
                const iconTxt = tx.signed_amount >= 0 ? '⬇' : '⬆';
                const el = document.createElement('div');
                el.className = 'row';
                el.innerHTML = `
          <div class="avatar">${iconTxt}</div>
          <div>
            <div class="title">${tx.description || 'Операция'}${who}</div>
            <div class="sub">${fmtDT(tx.timestamp)}</div>
          </div>
          <div class="${signClass}">${sign}${fmtMoney(tx.amount)}</div>
        `;
                txList.appendChild(el);
            }
        }

        async function refreshTx() {
            const data = await api('/api/transactions');
            renderTx(data.transactions || []);
        }

        // Login/logout/topup
        btnLogin.addEventListener('click', async () => {
            const id = (loginId.value || '').trim();
            if (!id) return showToast('Введите ID');
            try {
                await api('/api/login', { method: 'POST', body: JSON.stringify({ user_id: id }) });
                showToast('Готово');
                await refreshMe();
            } catch (e) {
                showToast(e.message || 'Ошибка входа');
            }
        });

        btnLogout.addEventListener('click', async () => {
            try { await api('/api/logout', { method: 'POST' }); } catch { }
            currentUser = null;
            showToast('Вы вышли');
            await refreshMe();
        });

        btnTopup.addEventListener('click', async () => {
            const amount = prompt('Сумма пополнения (тест):', '500');
            if (!amount) return;
            const val = parseFloat(amount);
            if (isNaN(val) || val <= 0) return showToast('Некорректная сумма');
            try {
                const { balance } = await api('/api/topup', { method: 'POST', body: JSON.stringify({ amount: val }) });
                balanceValueEl.textContent = fmtMoney(balance);
                await refreshTx();
                showToast('Баланс пополнен');
            } catch (e) {
                showToast(e.message || 'Ошибка пополнения');
            }
        });

        // Create invoice sheet
        btnCreate.addEventListener('click', () => setSheetOpen(createSheet, createBackdrop, true));
        closeCreate.addEventListener('click', () => setSheetOpen(createSheet, createBackdrop, false));
        createBackdrop.addEventListener('click', () => setSheetOpen(createSheet, createBackdrop, false));
        clearCreate.addEventListener('click', () => {
            invAmount.value = '';
            invDesc.value = '';
            invResult.style.display = 'none';
        });

        doCreate.addEventListener('click', async () => {
            const amount = parseFloat(invAmount.value);
            const description = invDesc.value || '';
            if (isNaN(amount) || amount <= 0) return showToast('Введите корректную сумму');
            try {
                const { invoice, qr_text, qr_png } = await api('/api/create_invoice', {
                    method: 'POST',
                    body: JSON.stringify({ amount, description })
                });
                invQRImg.src = qr_png;
                invResult.style.display = '';
                invTextLabel.textContent = `Код: ${qr_text}`;
                showToast('Счет создан');
            } catch (e) {
                showToast(e.message || 'Не удалось создать счет');
            }
        });

        copyLink.addEventListener('click', async () => {
            const text = invTextLabel.textContent.replace(/^Код:\s*/, '');
            try { await navigator.clipboard.writeText(text); showToast('Скопировано'); } catch { showToast('Не удалось скопировать'); }
        });
        saveQR.addEventListener('click', () => {
            const a = document.createElement('a');
            a.href = invQRImg.src;
            a.download = 'invoice_qr.png';
            a.click();
        });
        shareQR.addEventListener('click', async () => {
            const text = invTextLabel.textContent.replace(/^Код:\s*/, '');
            try {
                if (navigator.share) {
                    await navigator.share({ title: 'Счет для оплаты', text });
                } else {
                    await navigator.clipboard.writeText(text);
                    showToast('Код скопирован');
                }
            } catch { }
        });

        // Scan sheet
        btnScan.addEventListener('click', () => setSheetOpen(scanSheet, scanBackdrop, true));
        closeScan.addEventListener('click', () => { stopCamera(); setSheetOpen(scanSheet, scanBackdrop, false); });
        scanBackdrop.addEventListener('click', () => { stopCamera(); setSheetOpen(scanSheet, scanBackdrop, false); });

        startScan.addEventListener('click', startCamera);
        stopScan.addEventListener('click', stopCamera);

        imgInput.addEventListener('change', async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            const bmp = await createImageBitmap(file);
            const c = canvas;
            const ctx = c.getContext('2d');
            c.width = bmp.width; c.height = bmp.height;
            ctx.drawImage(bmp, 0, 0);
            const imgData = ctx.getImageData(0, 0, c.width, c.height);
            const code = jsQR(imgData.data, imgData.width, imgData.height);
            if (code?.data) {
                await payByQRText(code.data);
            } else {
                showToast('Код не распознан');
            }
        });

        payManual.addEventListener('click', async () => {
            const txt = manualQR.value.trim();
            if (!txt) return showToast('Вставьте код');
            await payByQRText(txt);
        });

        async function payByQRText(text) {
            try {
                const res = await api('/api/pay_invoice', { method: 'POST', body: JSON.stringify({ qr_text: text }) });
                await refreshMe();
                showToast('Счет оплачен');
                stopCamera();
                setSheetOpen(scanSheet, scanBackdrop, false);
            } catch (e) {
                showToast(e.message || 'Не удалось оплатить');
            }
        }

        async function startCamera() {
            try {
                scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = scanStream;
                await video.play();
                scanning = true;
                if (usingBarcodeDetector) {
                    scanLoopBarcodeDetector();
                } else {
                    scanLoopJSQR();
                }
            } catch (e) {
                showToast('Нет доступа к камере');
            }
        }

        function stopCamera() {
            scanning = false;
            if (scanRAF) cancelAnimationFrame(scanRAF);
            if (video) { video.pause(); video.srcObject = null; }
            if (scanStream) {
                scanStream.getTracks().forEach(t => t.stop());
                scanStream = null;
            }
        }

        async function scanLoopBarcodeDetector() {
            const detector = new BarcodeDetector({ formats: ['qr_code'] });
            const c = canvas; const ctx = c.getContext('2d');
            const tick = async () => {
                if (!scanning) return;
                if (video.readyState >= 2) {
                    c.width = video.videoWidth; c.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, c.width, c.height);
                    try {
                        const codes = await detector.detect(c);
                        if (codes && codes.length) {
                            const val = codes[0].rawValue || codes[0].rawValueText || codes[0].rawValueString || '';
                            if (val) {
                                scanning = false;
                                await payByQRText(val);
                                return;
                            }
                        }
                    } catch { }
                }
                scanRAF = requestAnimationFrame(tick);
            };
            scanRAF = requestAnimationFrame(tick);
        }

        function scanLoopJSQR() {
            const c = canvas; const ctx = c.getContext('2d');
            const tick = async () => {
                if (!scanning) return;
                if (video.readyState >= 2) {
                    c.width = video.videoWidth; c.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, c.width, c.height);
                    const imgData = ctx.getImageData(0, 0, c.width, c.height);
                    const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: "dontInvert" });
                    if (code && code.data) {
                        scanning = false;
                        await payByQRText(code.data);
                        return;
                    }
                }
                scanRAF = requestAnimationFrame(tick);
            };
            scanRAF = requestAnimationFrame(tick);
        }

        // Init
        refreshMe();
    </script>
</body>

</html>