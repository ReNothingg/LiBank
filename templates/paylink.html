{% extends "base.html" %}
{% set page = "paylink" %}
{% block extra_libs %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
{% endblock %}
{% block content %}
<div class="screen">
    <div class="card">
        <h1 class="title">Счёт на оплату</h1>
        <div id="paylinkInfo" class="invoice-preview">Загружаем детали...</div>
        <div class="mt-12">
            <a href="/account" class="btn secondary full">Открыть в приложении</a>
            <button id="paylinkPayBtn" class="btn primary full mt-8">Оплатить сейчас</button>
        </div>
        <div class="muted small mt-12">
            Подсказка: вы можете сканировать этот URL через камеру на странице аккаунта.
        </div>
    </div>
</div>
{% endblock %}
{% block page_js %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const info = document.getElementById('paylinkInfo');
        const payBtn = document.getElementById('paylinkPayBtn');
        const paylink = window.location.href;
        try {
            const res = await apiFetch('/api/pay/preview', { method: 'POST', body: JSON.stringify({ paylink }) });
            if (!res.ok) {
                info.innerHTML = `<div class="error">Ошибка: ${res.error || 'Не удалось получить данные счёта'}</div>`;
                payBtn.disabled = true;
                return;
            }
            const inv = res.invoice;
            info.innerHTML = `
        <div><b>Кому:</b> @${inv.recipient_username}</div>
        <div><b>Сумма:</b> ${inv.amount_display}</div>
        <div><b>Назначение:</b> ${inv.description || '—'}</div>
      `;
            payBtn.onclick = async () => {
                const payRes = await apiFetch('/api/pay', { method: 'POST', body: JSON.stringify({ paylink }) });
                if (payRes.ok) {
                    toastSuccess('Оплата выполнена');
                    setTimeout(() => window.location.href = '/account', 600);
                } else {
                    toastError(payRes.error || 'Оплата не удалась');
                }
            };
        } catch (e) {
            info.innerHTML = `<div class="error">Ошибка загрузки</div>`;
            payBtn.disabled = true;
        }
    });
</script>
{% endblock %}